name: Pull Request Automation Workflow

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  code-quality:
    name: code-quality
    runs-on: ubuntu-latest
    outputs:
      comment-body: ${{ steps.generate-comment.outputs.comment-body }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run ESLint checks
      id: eslint
      run: |
        echo "Running ESLint checks..."
        npm run lint
        echo "::notice::ESLint checks completed successfully"
      continue-on-error: true
    
    - name: Run Prettier formatting checks
      id: prettier
      run: |
        echo "Running Prettier formatting checks..."
        npx prettier --check src/
        echo "::notice::Prettier formatting checks completed"
      continue-on-error: true
    
    - name: Generate Code Quality Report
      id: generate-comment
      run: |
        ESLINT_STATUS="${{ steps.eslint.outcome }}"
        PRETTIER_STATUS="${{ steps.prettier.outcome }}"
        
        COMMENT_BODY="## Code Quality Report
        
        ### ESLint Status: $([ '$ESLINT_STATUS' = 'success' ] && echo '✅ Passed' || echo '❌ Failed')
        $([ '$ESLINT_STATUS' = 'success' ] && echo 'All ESLint rules passed successfully.' || echo 'ESLint found issues that need to be addressed.')
        
        ### Prettier Status: $([ '$PRETTIER_STATUS' = 'success' ] && echo '✅ Passed' || echo '❌ Failed')
        $([ '$PRETTIER_STATUS' = 'success' ] && echo 'Code formatting is consistent with Prettier standards.' || echo 'Code formatting issues detected. Please run \`npm run format\` to fix.')
        
        ---
        *This report was automatically generated by the Code Quality job*"
        
        echo "comment-body<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMENT_BODY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Post Code Quality Comment
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Code Quality Report')
          );
          
          const comment_body = process.env.COMMENT_BODY;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              comment_id: botComment.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment_body
            });
          } else {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment_body
            });
          }
      env:
        COMMENT_BODY: ${{ steps.generate-comment.outputs.comment-body }}

  testing-suite:
    name: testing-suite
    runs-on: ubuntu-latest
    outputs:
      comment-body: ${{ steps.generate-comment.outputs.comment-body }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests with coverage
      id: tests
      run: |
        echo "Running test suite with coverage..."
        npm run test:coverage
        echo "::notice::Test suite completed"
      continue-on-error: true
    
    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report-${{ github.run_number }}
        path: coverage/
        retention-days: 30
    
    - name: Generate Test Coverage Report
      id: generate-comment
      run: |
        TEST_STATUS="${{ steps.tests.outcome }}"
        
        if [ -f "coverage/coverage-summary.json" ]; then
          TOTAL_LINES=$(jq '.total.lines.pct' coverage/coverage-summary.json 2>/dev/null || echo "N/A")
          TOTAL_FUNCTIONS=$(jq '.total.functions.pct' coverage/coverage-summary.json 2>/dev/null || echo "N/A")
          TOTAL_BRANCHES=$(jq '.total.branches.pct' coverage/coverage-summary.json 2>/dev/null || echo "N/A")
          TOTAL_STATEMENTS=$(jq '.total.statements.pct' coverage/coverage-summary.json 2>/dev/null || echo "N/A")
        else
          TOTAL_LINES="N/A"
          TOTAL_FUNCTIONS="N/A"
          TOTAL_BRANCHES="N/A"
          TOTAL_STATEMENTS="N/A"
        fi
        
        COMMENT_BODY="## Test Coverage Report
        
        ### Test Status: $([ '$TEST_STATUS' = 'success' ] && echo '✅ Passed' || echo '❌ Failed')
        
        ### Coverage Summary:
        - **Lines**: ${TOTAL_LINES}%
        - **Functions**: ${TOTAL_FUNCTIONS}%
        - **Branches**: ${TOTAL_BRANCHES}%
        - **Statements**: ${TOTAL_STATEMENTS}%
        
        $([ '$TEST_STATUS' = 'success' ] && echo 'All tests passed successfully. Coverage artifacts have been uploaded for detailed analysis.' || echo 'Tests failed. Please check the test output for details.')
        
        ---
        *This report was automatically generated by the Testing Suite job*"
        
        echo "comment-body<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMENT_BODY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Post Test Coverage Comment
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Test Coverage Report')
          );
          
          const comment_body = process.env.COMMENT_BODY;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              comment_id: botComment.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment_body
            });
          } else {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment_body
            });
          }
      env:
        COMMENT_BODY: ${{ steps.generate-comment.outputs.comment-body }}

  security-scan:
    name: security-scan
    runs-on: ubuntu-latest
    outputs:
      comment-body: ${{ steps.generate-comment.outputs.comment-body }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run npm audit for vulnerabilities
      id: audit
      run: |
        echo "Running dependency vulnerability checks..."
        npm audit --audit-level moderate
        echo "::notice::Dependency audit completed"
      continue-on-error: true
    
    - name: Scan for secrets in code changes
      id: secret-scan
      run: |
        echo "Scanning for secrets in code changes..."
        
        # Simple secret detection patterns
        if git diff --name-only HEAD~1 HEAD | grep -E '\.(js|json|env|config)$'; then
          echo "Checking for potential secrets in changed files..."
          
          # Look for common secret patterns
          SECRET_PATTERNS=(
            "api[_-]?key[[:space:]]*=[[:space:]]*['\"][^'\"]{10,}['\"]"
            "password[[:space:]]*=[[:space:]]*['\"][^'\"]{6,}['\"]"
            "secret[[:space:]]*=[[:space:]]*['\"][^'\"]{10,}['\"]"
            "token[[:space:]]*=[[:space:]]*['\"][^'\"]{20,}['\"]"
            "AKIA[0-9A-Z]{16}" # AWS Access Key ID pattern
            "[0-9a-f]{32}" # Potential API keys/hashes
          )
          
          SECRETS_FOUND=0
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if git diff HEAD~1 HEAD | grep -iE "$pattern" > /dev/null; then
              echo "::warning::Potential secret pattern detected: $pattern"
              SECRETS_FOUND=1
            fi
          done
          
          if [ $SECRETS_FOUND -eq 0 ]; then
            echo "::notice::No secrets detected in code changes"
          fi
        else
          echo "::notice::No relevant files changed for secret scanning"
        fi
      continue-on-error: true
    
    - name: Generate Security Scan Report
      id: generate-comment
      run: |
        AUDIT_STATUS="${{ steps.audit.outcome }}"
        SECRET_STATUS="${{ steps.secret-scan.outcome }}"
        
        COMMENT_BODY="## Security Scan Report
        
        ### Vulnerabilities Status: $([ '$AUDIT_STATUS' = 'success' ] && echo '✅ Passed' || echo '❌ Issues Found')
        $([ '$AUDIT_STATUS' = 'success' ] && echo 'No critical or moderate vulnerabilities found in Dependencies.' || echo 'Security vulnerabilities detected in Dependencies. Please review the audit output.')
        
        ### Secret Scan Status: $([ '$SECRET_STATUS' = 'success' ] && echo '✅ Clean' || echo '⚠️ Review Needed')
        $([ '$SECRET_STATUS' = 'success' ] && echo 'No secrets detected in code changes.' || echo 'Potential secret patterns found. Please review the code changes.')
        
        ### Dependencies Security:
        - Regular security audits are recommended
        - Keep dependencies updated to latest secure versions
        - Review npm audit output for detailed vulnerability information
        
        ---
        *This report was automatically generated by the Security Scan job*"
        
        echo "comment-body<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMENT_BODY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Post Security Scan Comment
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Security Scan Report')
          );
          
          const comment_body = process.env.COMMENT_BODY;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              comment_id: botComment.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment_body
            });
          } else {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment_body
            });
          }
      env:
        COMMENT_BODY: ${{ steps.generate-comment.outputs.comment-body }}

  build-validation:
    name: build-validation
    runs-on: ubuntu-latest
    outputs:
      comment-body: ${{ steps.generate-comment.outputs.comment-body }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build application
      id: build
      run: |
        echo "Building application..."
        npm run build
        echo "::notice::Build completed successfully"
      continue-on-error: true
    
    - name: Validate endpoints accessibility
      id: endpoints
      run: |
        echo "Validating endpoints accessibility..."
        
        # Start the application in background
        npm start &
        APP_PID=$!
        
        # Wait for app to start
        sleep 5
        
        # Test health endpoint
        if curl -f http://localhost:3000/health > /dev/null 2>&1; then
          echo "::notice::Health endpoint is accessible"
          ENDPOINTS_STATUS="success"
        else
          echo "::warning::Health endpoint not accessible"
          ENDPOINTS_STATUS="failure"
        fi
        
        # Stop the application
        kill $APP_PID 2>/dev/null || true
      continue-on-error: true
    
    - name: Create deployment preview artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-artifacts-${{ github.run_number }}
        path: |
          src/
          package.json
          package-lock.json
        retention-days: 7
    
    - name: Generate Build Validation Report
      id: generate-comment
      run: |
        BUILD_STATUS="${{ steps.build.outcome }}"
        ENDPOINTS_STATUS="${{ steps.endpoints.outcome }}"
        
        COMMENT_BODY="## Build Validation
        
        ### Build Status: $([ '$BUILD_STATUS' = 'success' ] && echo '✅ Successful' || echo '❌ Failed')
        $([ '$BUILD_STATUS' = 'success' ] && echo 'Application built successfully without errors.' || echo 'Build process failed. Please check the build logs for details.')
        
        ### Endpoints Validation: $([ '$ENDPOINTS_STATUS' = 'success' ] && echo '✅ Accessible' || echo '❌ Issues Found')
        $([ '$ENDPOINTS_STATUS' = 'success' ] && echo 'All endpoints are accessible and responding correctly.' || echo 'Some endpoints are not accessible. Please check the application configuration.')
        
        ### Artifacts:
        - Build artifacts have been uploaded for deployment preview
        - Application package is ready for deployment
        
        ---
        *This report was automatically generated by the Build Validation job*"
        
        echo "comment-body<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMENT_BODY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Post Build Validation Comment
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Build Validation')
          );
          
          const comment_body = process.env.COMMENT_BODY;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              comment_id: botComment.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment_body
            });
          } else {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment_body
            });
          }
      env:
        COMMENT_BODY: ${{ steps.generate-comment.outputs.comment-body }}